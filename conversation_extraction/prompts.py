### 还得是尝试分割，然后总结规则。
### 可以考虑多次分割然后想办法整合。因为确实存在不一致。
### 还需要更新example，用于获取更多thought

FORMAT_CORRECTION='''给定一段不太符合输出格式的文本，保留文本内容，修正这段文本的格式。
正确的格式如下：
{}

目前不符合输出格式的文本如下：
{}
请根据我提供的输出格式，保留文本内容，修正这段文本的格式
'''



TEXT2SPEAKER_SPLIT_RULE_SYS = '''你是一位精通自然语言处理的专家，负责分析直播音频转录文本。这些转录文本包含独白、旁白和多人对话，通常表现为非结构化、漫无边际的文字。'''
TEXT2SPEAKER_SPLIT_RULE_USER = '''
任务：分析以下ASR转录文本，将其划分为不同说话人以及旁白的片段。然后总结合适的、清晰的规则，方便后续的自动分割类似的转录文本设计。

ASR转录文本：
"""
{{asr_text}}
"""

输出格式：
<说话人分割>
[你的分割，带有说话人标签，用markdown表格的形式呈现]
</说话人分割>

<分割规则>
[你总结的分割规则]
</分割规则>

请按照以下步骤操作：
1. 识别文本中可能的说话人转换点
2. 标记每个说话人的开始和结束
3. 提供每个分割决策的理由
4. 基于你的分析，总结一套合适的、清晰的说话人分割规则
重点关注能表明不同说话人的语言模式、对话转换、问答对以及说话风格的变化。
'''

AGGREGATE_RULES_SYS = '''你是一位专门分析和总结文本的NLP专家。'''
AGGREGATE_RULES_USER = '''我收集了多个说话人分割规则样本，需要你将它们总结为一套统一的、全面的规则。
这些规则将用于将ASR转录文本划分为不同说话人的片段。

以下是收集到的所有规则样本:
```
{{combined_rules}}
```

请分析这些样本，总结出一套最佳的说话人分割规则。你的输出应该:
1. 保留所有有用的规则要点
2. 去除重复内容
3. 组织成清晰、结构化的格式
4. 总结最重要的规则，忽略不具备泛化性的、样本特定的规则
请只输出总结的规则，不要包含其他文本
'''



SPEAKER_SPLIT_SYS = '''你是一个专业的音频转录分析专家，擅长处理口语化、非结构化的直播内容。'''

SPEAKER_SPLIT_USER = '''我需要你帮我分析以下来自未明子直播的ASR转录文本，并按说话人进行分割。
这批文本数据来自直播视频的音频转录，主要包含一位主讲人讨论时事、分享知识以及与观众连麦互动的内容。文本具有明显的口语化特征，包含大量重复、口头禅和情绪化表达。内容主题广泛，涵盖社会评论、哲学政治理论、生活建议、教育问题和阶级批判等。
文本结构呈现两种主要模式：一是主讲人的长篇独白，思路跳跃且内容丰富但组织松散；二是与连麦观众的互动对话，表现为问答交替但边界模糊。主讲人表现出广泛的知识背景，语言风格直接、情绪外露，常用举例说明复杂概念，偶尔使用粗俗语言表达强烈情绪。对话部分特征是交流节奏不稳定，有打断、催促和情绪化反应。
转录文本存在ASR特有的问题，如词语重复、语义不连贯，以及标点使用不规范。文本中还混杂有表情符号等非语言元素。说话人切换通常没有明确标记，需要依靠内容、语气和交流模式的变化来识别不同的说话人。

【如何分割说话人，分割说话人的原则】
{split_rules}

【ASR处理历史】
{asr_history}

【ASR转录文本】
{asr_raw_text}

【输出格式】
请按以下格式输出分割结果：
```
<SEGMENT>
<ID>编号</ID>
<ANALYSIS>为什么在此处进行分割的分析，包括语言风格变化、话题转换、代词变化等关键线索</ANALYSIS>
<SPEAKER>未明子/连麦用户/旁白/背景音频</SPEAKER>
<CONTENT>完整保留的原始文本，不要摘要或精简</CONTENT>
</SEGMENT>
```
例如：
{speaker_split_examples}
...

请仔细分析ASR转录文本中的对话模式、语气变化和内容衔接，根据上述要求以及提供的ASR处理历史，准确区分ASR转录文本中不同说话人及其说话内容。保持原始说话内容的完整，不要进行摘要或改写。
'''


SPEAKER_SPLIT_EXAMPLES = '''<SEGMENT>
<ID>1</ID>
<ANALYSIS>这是开场连麦用户的自我介绍</ANALYSIS>
<SPEAKER>连麦用户</SPEAKER>
<CONTENT>那个魏名四，你好，你又是个女儿啊，我靠能听到我说话，那个我是一个我是一个高三的女生。🎼然后我今天我今天回家了，我今天今天的时候我我本来在办公室，我我本来在办公室自学，然后我们老师过来找我。然后让我回家自学，我感觉我感觉我很自以为是，因为我有一个很创伤的高三</CONTENT>
</SEGMENT>
<SEGMENT>
<ID>2</ID>
<ANALYSIS>说话主语变化为高三学生，结合上下文分析可以推测此处的“你”指的是连麦用户女生，因此该说话人是未明子。</ANALYSIS>
<SPEAKER>未明子</SPEAKER>
<CONTENT>你高三没结束呢，你还有一个月不到的时间呢。</CONTENT>
</SEGMENT>'''

SPEAKER_SPLIT_FORMAT='''【输出格式】
请按以下格式输出分割结果：
```
<SEGMENT>
<ID>编号</ID>
<ANALYSIS>为什么在此处进行分割的分析，包括语言风格变化、话题转换、代词变化等关键线索</ANALYSIS>
<SPEAKER>未明子/连麦用户/旁白/背景音频</SPEAKER>
<CONTENT>完整保留的原始文本，不要摘要或精简</CONTENT>
</SEGMENT>
```
例如：
<SEGMENT>
<ID>1</ID>
<ANALYSIS>这是开场连麦用户的自我介绍</ANALYSIS>
<SPEAKER>连麦用户</SPEAKER>
<CONTENT>那个魏名四，你好，你又是个女儿啊，我靠能听到我说话，那个我是一个我是一个高三的女生。🎼然后我今天我今天回家了，我今天今天的时候我我本来在办公室，我我本来在办公室自学，然后我们老师过来找我。然后让我回家自学，我感觉我感觉我很自以为是，因为我有一个很创伤的高三</CONTENT>
</SEGMENT>
<SEGMENT>
<ID>2</ID>
<ANALYSIS>说话主语变化为高三学生，结合上下文分析可以推测此处的“你”指的是连麦用户女生，因此该说话人是未明子。</ANALYSIS>
<SPEAKER>未明子</SPEAKER>
<CONTENT>你高三没结束呢，你还有一个月不到的时间呢。</CONTENT>
</SEGMENT>
'''

EXTRACTION_V5 = '''# 任务背景
你是一个专业的问答数据提取助手。你的任务是从老师与学生的连麦对话ASR转录文本中，提取高质量的问答对用于AI训练。

## 处理机制说明
当前采用分段式处理机制：
1. **窗口化处理**：将完整ASR文本分割为多个上下文窗口（约1024 token）
2. **窗口内多轮处理**：在单个窗口内，你可能需要进行多轮分析和处理
3. **QA集合维护**：维护一个全局的QA集合，跨窗口累积信息
4. **历史动作追踪**：记录在当前窗口内的所有历史动作，用于避免重复和过度停留
5. **窗口完成判断**：当前窗口的主要信息都已提取并整合到QA集合后，标记窗口完成
6. **窗口跳转**：收到窗口完成标记后，系统会自动跳转到下一个上下文窗口

你的任务是在每轮处理中，综合分析当前文本片段、已有QA集合、历史动作记录，然后决定采取什么行动。

# 任务目标
- 提取完整、详细的问答对，确保问题包含充足的背景信息
- 保持老师回答的原有风格（口语化、用例、共情、比喻等）
- 避免信息丢失和主旨偏离
- 确保每个QA对都是逻辑完整、可独立使用的训练数据
- 保持高效处理，避免在单个窗口或问题上过度停留

# 输入信息
- ASR上下文窗口：当前需要处理的文本片段
- 当前QA集合：已经提取的问答对列表
- 历史动作窗口：当前窗口内的所有历史动作记录

# 可选动作
1. **enrich_existing**：为已有问题丰富背景信息或完善回答
2. **add_new_QA**：添加新的完整问答对
3. **window_complete**：当前窗口信息已充分提取，可以跳转到下一个窗口

# 处理指南

## 历史动作分析原则
在决定下一步动作前，必须分析历史动作模式：
**过度停留警告信号：**
- 同一QA索引被enrich超过2次
- 连续3个动作都是enrich_existing

## 丰富现有QA (enrich_existing)
**使用条件：**
- 当前文本片段为已有问题提供了重要的背景信息
- 当前文本片段包含对已有回答的关键补充或具体操作细节
- 最近的动作不是针对同一QA的重复enrich

## 添加新QA (add_new_QA)  
**使用条件：**
- 当前文本片段发现了明确的新主题
- 学生提出了与已有QA明显不同的困惑
- 老师并不必须要在窗口就直接给出完整的解答（有可能后续窗口可能会有）

## 窗口完成 (window_complete)
**推荐条件：**
- 当前窗口的主要问题和回答都已被提取
- 已有的QA集合基本涵盖了当前窗口的核心信息
- 最近动作的reasoning和目标index高度相似

# 质量标准
**问答要求：**
- 问题表述要清晰具体，避免过于宽泛
- 窗口内原文的问题有可能没有包含完全的信息，后续可以继续丰富
- 严格保留老师的原话风格和表达方式
- 包含具体的解决方案或操作建议
- 保持逻辑完整性，避免断章取义

**效率要求：**
- 优先提取核心主题的QA，次要细节可以适当忽略
- 避免为了完美而过度雕琢，90%的信息覆盖率就足够好

# 历史动作
{history_actions}

# 当前QA集合
{qa_list}

# ASR上下文窗口
{context_window}

# 输出格式要求
请按以下格式思考并输出：

## 思考过程：
1. **当前文本片段分析**：这段文本的主要内容是什么？涉及哪些问题或观点？
2. **历史动作分析**：当前窗口已进行了几次动作？是否存在过度停留的信号（重复enrich、动作数过多等）？
3. **与现有QA对比**：这些内容与已有QA集合有什么关系？是补充、重复还是全新内容？
4. **窗口完成度评估**：当前窗口的信息提取程度如何？还有重要信息未提取吗？
5. **动作判断**：基于文本分析和历史动作分析，应该采取什么行动？是否触发了强制window_complete的条件？
6. **具体执行**：如果要采取行动，具体如何组织问题和回答？

## 最终输出：
```json
{{
  "action": "enrich_existing|add_new_QA|window_complete",
  "target_qa_index": "如果是enrich_existing，指定要丰富的QA索引号",
  "question": "完整的问题表述（window_complete时可为空）",
  "answer": "完整的回答内容（window_complete时可为空）",
  "reasoning": "选择此动作的理由，需要引用历史动作分析结果"
}}
```

# 注意事项
- **历史动作优先**：必须根据历史动作模式判断是否过度停留
- **强制退出机制**：触发强制条件时必须选择window_complete
- **效率与质量平衡**：宁可略有遗漏，也要保证处理效率
- 绝对不能改变老师回答的原意和风格
- 确保每个QA对都能独立理解，无需依赖其他上下文
现在请开始处理。'''